%!TEX root = std.tex
\setcounter{chapter}{13}
\rSec0[cpp]{Preprocessing directives}%

\begin{after}
Modify paragraph 14/5 as follows:

\begin{std.txt}
\resetalinea[4]
\alinea
The implementation can
process and skip sections of source files conditionally,
include other source files,
\added{import macros from header units,}
and replace macros.
These capabilities are called
\term{preprocessing},
because conceptually they occur
before translation of the resulting translation unit.
\end{std.txt}
\end{after}

\setcounter{section}{1}
\rSec1[cpp.include]{Source file inclusion}%

\begin{after}
Add a new paragraph after 14.2/6 as follows:

\begin{std.txt}
\resetalinea[6]
\color{addclr}
\alinea
If the header identified by the \grammarterm{header-name}
denotes an importable header (\ref{dcl.module.import}),
the preprocessing directive
is instead replaced by the \grammarterm{preprocessing-token}{s}

\begin{bnf}
\terminal{import} header-name \terminal{;}
\end{bnf}
\end{std.txt}
\end{after}

\noindent
Add a new subclause 14.3 titled ``\textbf{Global module fragment}'' as follows:

\setcounter{section}{2}
\rSec1[cpp.glob.frag]{Global module fragment}%
\resetalinea[0]

\begin{std.txt}
\color{addclr}
\begin{bnf}
\nonterminal{pp-global-module-fragment}:\br
  \terminal{module} \terminal{;} pp-bracketed-tokens \terminal{module}
\end{bnf}

\alinea
If the first two preprocessing tokens at the start of phase 4 of translation
are \tcode{module} \tcode{;}, the result of preprocessing shall begin with
a \grammarterm{pp-global-module-fragment} for which all
\grammarterm{preprocessing-token}{s} in the \grammarterm{pp-bracketed-tokens}
were produced directly or indirectly by source file inclusion
(\ref{cpp.include}), and for which the second \tcode{module}
\grammarterm{preprocessing-token} was not produced by source file inclusion or
macro replacement (\stdref{cpp.replace}{14.3}).
Otherwise, the first two preprocessing tokens at the end of phase 4 of
translation shall not be \tcode{module} \tcode{;}.
\end{std.txt}

Add a new subclause 14.4 titled ``\textbf{Legacy header units}'' as follows:

\setcounter{section}{3}
\rSec1[cpp.module]{Legacy header units}%
\resetalinea[0]

\begin{std.txt}
\color{addclr}
\begin{bnf}
\nonterminal{pp-import}:\br
  \terminal{import} header-name pp-decl-suffix\opt{} \terminal{;}
\end{bnf}

\begin{bnf}
\nonterminal{pp-decl-suffix}:\br
  pp-decl-suffix\opt{} pp-decl-suffix-token\br
  pp-decl-suffix\opt{} \terminal{[} pp-bracketed-tokens \terminal{]}
\end{bnf}

\begin{bnf}
\nonterminal{pp-decl-suffix-token}:\br
  \descr{any \grammarterm{preprocessing-token} other than \terminal{[}, \terminal{]}, or \terminal{;}}
\end{bnf}

\begin{bnf}
\nonterminal{pp-bracketed-tokens}:\br
  pp-bracketed-tokens\opt{} pp-bracketed-token\br
  pp-bracketed-tokens\opt{} \terminal{[} pp-bracketed-tokens \terminal{]}
\end{bnf}

\begin{bnf}
\nonterminal{pp-bracketed-token}:\br
  \descr{any \grammarterm{preprocessing-token} other than \terminal{[} or \terminal{]}}
\end{bnf}

\color{addclr}
\alinea
A sequence of \grammarterm{preprocessing-token}{s} matching the form
of a \grammarterm{pp-import}
instructs the preprocessor to import macros from the header unit
(\ref{dcl.module.import}) denoted by the \grammarterm{header-name}.
The \tcode{;} \grammarterm{preprocessing-token} shall not be produced by
macro replacement (\stdref{cpp.replace}{14.3}).
The \term{point of macro import} for a \grammarterm{pp-import} is
immediately after the \tcode{;} terminating the \grammarterm{pp-import}.

\color{addclr}
\alinea
A \term{macro directive} for a macro name is a \tcode{\#define} or
\tcode{\#undef} directive naming that macro name.
An \term{exported macro directive} is
a macro directive occuring in a header unit
\color{addclr}
whose macro name is not lexically identical to a keyword.
A macro directive is \term{visible} at a source location
if it precedes that source location in the same translation unit, or
if it is an exported macro directive whose header unit,
or a header unit that
\color{addclr}
transitively imports it,
is imported into the current translation unit by a \grammarterm{pp-import}
whose point of macro import precedes that source location.

\alinea
Multiple macro directives for a macro name may be visible at the same
source location.
The interpretation of a macro name is determined as follows:
\begin{itemize}
\item
\color{addclr}
A macro directive \term{overrides} all macro directives for the same name
that are visible at the point of the directive.
\item
\color{addclr}
A macro directive is \term{active} if it is visible and
no visible macro directive overrides it.
\item
\color{addclr}
A set of macro directives is \term{consistent} if it consists of only
\tcode{\#undef} directives or if all \tcode{\#define} directives in the set
are valid as redefinitions of the same macro.
\end{itemize}
\color{addclr}
When a \grammarterm{preprocessing-token} matching the macro name of a visible
macro directive is encountered, the set of active macro directives for that
macro name shall be consistent, and semantics of the active macro directives
determine whether the macro name is defined and the behavior of macro
replacement.
\enternote
The relative order of \grammarterm{pp-import}{s} has no bearing on whether a
particular macro definition is active.
\exitnote
\end{std.txt}
